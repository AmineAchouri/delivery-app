name: Frontend Deploy
on:
  workflow_dispatch:
    inputs:
      env:
        description: Environment (test or prod)
        required: true
        type: choice
        options: [ test, prod ]
      image_tag:
        description: Optional override image tag
        required: false
      ecs_cluster:
        description: ECS cluster name
        required: true
      ecs_service:
        description: ECS service name
        required: true
jobs:
  build-image:
    runs-on: ubuntu-latest
    outputs:
      image-uri: ${{ steps.out.outputs.image }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: docker/setup-buildx-action@v3
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - id: ecr
        uses: aws-actions/amazon-ecr-login@v2
      - name: Ensure ECR repo
        run: |
          aws ecr describe-repositories --repository-names delivery-frontend >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name delivery-frontend --image-scanning-configuration scanOnPush=true --encryption-configuration encryptionType=KMS
      - name: Build & push image
        id: out
        run: |
          REPO=delivery-frontend
          REGISTRY=${{ steps.ecr.outputs.registry }}
          TAG_INPUT='${{ github.event.inputs.image_tag }}'
          if [ -z "$TAG_INPUT" ]; then
            TAG_INPUT="$(date +%Y%m%d%H%M%S)-${{ github.event.inputs.env }}"
          fi
          IMAGE="$REGISTRY/$REPO:$TAG_INPUT"
          docker build -f admin/Dockerfile -t "$IMAGE" ./admin
          docker push "$IMAGE"
          echo "image=$IMAGE" >> "$GITHUB_OUTPUT"
  deploy-ecs:
    runs-on: ubuntu-latest
    needs: build-image
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: us-east-1
      - name: Render task definition
        run: |
          IMAGE_URI='${{ needs.build-image.outputs.image-uri }}'
          sed -e "s|\${IMAGE_URI}|$IMAGE_URI|g" \
              -e "s|\${AWS_REGION}|us-east-1|g" \
              -e "s|\${EXEC_ROLE_ARN}|${{ secrets.ECS_EXEC_ROLE_ARN }}|g" \
              -e "s|\${TASK_ROLE_ARN}|${{ secrets.ECS_TASK_ROLE_ARN }}|g" \
              -e "s|\${LOG_GROUP}|${{ secrets.ECS_LOG_GROUP }}|g" \
              -e "s|\${TASKDEF_FAMILY}|delivery-frontend-${{ github.event.inputs.env }}|g" \
              infra/admin-frontend-taskdef.template.json > taskdef.json
          cat taskdef.json
      - name: Register task definition
        id: reg
        run: |
          REV=$(aws ecs register-task-definition --cli-input-json file://taskdef.json --query "taskDefinition.revision" --output text)
          echo "rev=$REV" >> "$GITHUB_OUTPUT"
      - name: Update service
        run: |
          aws ecs update-service \
            --cluster '${{ github.event.inputs.ecs_cluster }}' \
            --service '${{ github.event.inputs.ecs_service }}' \
            --task-definition delivery-frontend-${{ github.event.inputs.env }}:${{ steps.reg.outputs.rev }} \
            --force-new-deployment
      - name: Wait stable
        run: aws ecs wait services-stable --cluster '${{ github.event.inputs.ecs_cluster }}' --services '${{ github.event.inputs.ecs_service }}'
