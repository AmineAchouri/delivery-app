// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Platform-level admin (not tied to any tenant)
model PlatformAdmin {
  admin_id      String   @id @default(uuid())
  email         String   @unique
  password_hash String
  name          String
  role          String   // SUPER_ADMIN or PLATFORM_ADMIN
  status        String   @default("active") // active, inactive, suspended
  created_by    String?  // admin_id of who created this admin (null for initial super admin)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  // Self-relation for created_by
  creator           PlatformAdmin?  @relation("AdminCreator", fields: [created_by], references: [admin_id])
  createdAdmins     PlatformAdmin[] @relation("AdminCreator")
  
  // Assigned tenants (only for PLATFORM_ADMIN role)
  assignedTenants   PlatformAdminTenant[]
  
  // Refresh tokens for platform admins
  refreshTokens     PlatformAdminRefreshToken[]
}

// Junction table: which tenants a platform admin can access
model PlatformAdminTenant {
  id          String   @id @default(uuid())
  admin_id    String
  tenant_id   String
  assigned_at DateTime @default(now())
  assigned_by String?  // admin_id of who assigned this

  admin  PlatformAdmin @relation(fields: [admin_id], references: [admin_id], onDelete: Cascade)
  tenant Tenant        @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)

  @@unique([admin_id, tenant_id])
}

// Refresh tokens for platform admins
model PlatformAdminRefreshToken {
  id           String    @id @default(uuid())
  admin_id     String
  token_hash   String    @unique
  created_at   DateTime  @default(now())
  expires_at   DateTime
  revoked_at   DateTime?

  admin PlatformAdmin @relation(fields: [admin_id], references: [admin_id], onDelete: Cascade)

  @@index([admin_id])
}

model Permission {
  permission_id   String           @id @default(uuid())
  name            String           @unique
  description     String?
  scope           String
  // Added opposite
  rolePermissions RolePermission[]
}

model User {
  user_id       String   @id @default(uuid())
  tenant_id     String
  email         String
  phone         String?
  password_hash String
  status        String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  last_active   DateTime? // Add this line if it doesn't exist

  tenant        Tenant         @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  roles         UserRole[]
  addresses     Address[]
  orders        Order[]
  auditLogs     AuditLog[]
  refreshTokens RefreshToken[]
  // Back-relation for Cart
  carts         Cart[]

  @@unique([tenant_id, email], name: "tenant_id_email")
}

model Role {
  role_id     String  @id @default(uuid())
  tenant_id   String
  name        String
  description String?

  tenant      Tenant           @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  users       UserRole[]
  permissions RolePermission[]

  @@unique([tenant_id, name])
}

model UserRole {
  user_role_id String   @id @default(uuid())
  user_id      String
  role_id      String
  tenant_id    String
  created_at   DateTime @default(now())

  user   User   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  role   Role   @relation(fields: [role_id], references: [role_id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)

  @@unique([user_id, role_id])
}

model RolePermission {
  role_permission_id String @id @default(uuid())
  role_id            String
  permission_id      String
  tenant_id          String

  role       Role       @relation(fields: [role_id], references: [role_id], onDelete: Cascade)
  permission Permission @relation(fields: [permission_id], references: [permission_id])
  tenant     Tenant     @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)

  @@unique([role_id, permission_id])
}

model Feature {
  feature_id      String          @id @default(uuid())
  feature_key     String          @unique
  default_enabled Boolean
  description     String?
  tenants         TenantFeature[]
}

model Tenant {
  tenant_id     String   @id @default(uuid())
  name          String
  domain        String   @unique
  status        String
  currency_code String
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt

  users           User[]
  roles           Role[]
  features        TenantFeature[]
  settings        TenantSetting[]
  menus           Menu[]
  offers          Offer[]
  media           Media[]
  auditLogs       AuditLog[]
  userRoles       UserRole[]
  rolePermissions RolePermission[]
  menuCategories  MenuCategory[]
  menuItems       MenuItem[]
  addresses       Address[]
  orders          Order[]
  mediaLinks      MediaLink[]
  refreshTokens   RefreshToken[]
  // Back-relations for Cart and CartItem
  carts           Cart[]
  cartItems       CartItem[]
  // Add back-relation for OrderItem
  orderItems      OrderItem[]
  // Platform admins assigned to this tenant
  platformAdmins  PlatformAdminTenant[]
}

model TenantFeature {
  tenant_feature_id String   @id @default(uuid())
  tenant_id         String
  feature_id        String
  is_enabled        Boolean  @default(false)
  config            Json?
  updated_at        DateTime @updatedAt

  tenant  Tenant  @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  feature Feature @relation(fields: [feature_id], references: [feature_id], onDelete: Cascade)

  @@unique([tenant_id, feature_id])
}

model TenantSetting {
  tenant_setting_id String   @id @default(uuid())
  tenant_id         String
  key               String
  value             Json
  updated_at        DateTime @updatedAt

  tenant Tenant @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)

  @@unique([tenant_id, key])
}

model Menu {
  menu_id     String   @id @default(uuid())
  tenant_id   String
  name        String
  description String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())

  tenant     Tenant         @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  categories MenuCategory[]

  @@unique([tenant_id, name])
}

model MenuCategory {
  category_id String @id @default(uuid())
  tenant_id   String
  menu_id     String
  name        String
  order_index Int    @default(0)

  tenant Tenant     @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  menu   Menu       @relation(fields: [menu_id], references: [menu_id], onDelete: Cascade)
  items  MenuItem[]

  @@unique([menu_id, name, tenant_id])
}

model MenuItem {
  item_id      String   @id @default(uuid())
  tenant_id    String
  category_id  String
  name         String
  description  String?
  price        Decimal
  is_available Boolean  @default(true)
  created_at   DateTime @default(now())

  tenant     Tenant       @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  category   MenuCategory @relation(fields: [category_id], references: [category_id], onDelete: Cascade)
  // Back-relation for CartItem
  cartItems  CartItem[]
  // Add back-relation for OrderItem
  orderItems OrderItem[]

  @@unique([category_id, name, tenant_id])
}

model Offer {
  offer_id        String    @id @default(uuid())
  tenant_id       String
  name            String
  description     String?
  discount_type   String
  discount_value  Decimal
  min_order_value Decimal?
  start_date      DateTime
  end_date        DateTime?
  is_active       Boolean   @default(true)

  tenant Tenant @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)

  @@unique([tenant_id, name])
}

model Address {
  address_id String @id @default(uuid())
  tenant_id  String
  user_id    String
  street     String
  city       String
  state      String
  zip        String
  lat        Float?
  lng        Float?

  tenant Tenant @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  user   User   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
}

model Order {
  order_id       String   @id @default(uuid())
  tenant_id      String
  user_id        String
  order_status   String
  payment_status String
  subtotal       Decimal
  tax            Decimal
  discount       Decimal
  total          Decimal
  currency_code  String
  created_at     DateTime @default(now())

  tenant Tenant @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  user   User   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)

  // Back-relation for OrderItem
  items OrderItem[]
}

model OrderItem {
  order_item_id String  @id @default(uuid())
  order_id      String
  tenant_id     String
  item_id       String
  name          String
  qty           Int
  unit_price    Decimal
  line_total    Decimal

  order  Order    @relation(fields: [order_id], references: [order_id], onDelete: Cascade)
  tenant Tenant   @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  item   MenuItem @relation(fields: [item_id], references: [item_id])

  @@index([order_id])
}

model Media {
  media_id   String   @id @default(uuid())
  tenant_id  String
  url        String
  type       String
  source     String
  created_at DateTime @default(now())

  tenant Tenant      @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  links  MediaLink[]
}

model MediaLink {
  link_id     String  @id @default(uuid())
  media_id    String
  tenant_id   String
  entity_type String
  entity_id   String
  purpose     String?

  media  Media  @relation(fields: [media_id], references: [media_id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)

  @@index([entity_type, entity_id, tenant_id])
}

model AuditLog {
  audit_id       String   @id @default(uuid())
  tenant_id      String
  user_id        String?
  entity_type    String
  entity_id      String
  action_type    String
  change_summary Json?
  created_at     DateTime @default(now())

  tenant Tenant @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  user   User?  @relation(fields: [user_id], references: [user_id], onDelete: SetNull)
}

// Refresh tokens model
model RefreshToken {
  refresh_token_id String    @id @default(uuid())
  user_id          String
  tenant_id        String
  token_hash       String    @unique
  created_at       DateTime  @default(now())
  revoked_at       DateTime?

  user   User   @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  tenant Tenant @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)

  @@index([user_id, tenant_id])
}

model Cart {
  cart_id    String   @id @default(uuid())
  tenant_id  String
  user_id    String
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt

  user   User       @relation(fields: [user_id], references: [user_id], onDelete: Cascade)
  tenant Tenant     @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)
  items  CartItem[]

  @@unique([tenant_id, user_id])
}

model CartItem {
  cart_item_id String   @id @default(uuid())
  cart_id      String
  tenant_id    String
  item_id      String
  qty          Int      @default(1)
  price        Decimal // snapshot of item price at add time
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  cart   Cart     @relation(fields: [cart_id], references: [cart_id], onDelete: Cascade)
  item   MenuItem @relation(fields: [item_id], references: [item_id], onDelete: Cascade)
  tenant Tenant   @relation(fields: [tenant_id], references: [tenant_id], onDelete: Cascade)

  @@unique([cart_id, item_id])
}
